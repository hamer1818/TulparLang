name: Cross-Platform Build (LLVM)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake llvm-18-dev
      
      - name: Build with LLVM
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release -j$(nproc)
        timeout-minutes: 10
      
      - name: Run tests
        run: |
          cp build/tulpar tulpar
          chmod +x tulpar
          ./build.sh test
        timeout-minutes: 5
        continue-on-error: true
      
      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp build/tulpar dist/tulpar-linux-x64
          cp build/libtulpar_runtime.a dist/libtulpar_runtime-linux-x64.a
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tulpar-linux-x64
          path: dist/tulpar-linux-x64
  
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew install cmake llvm@18
          echo 'export PATH="/opt/homebrew/opt/llvm@18/bin:$PATH"' >> ~/.zshrc
          export PATH="/opt/homebrew/opt/llvm@18/bin:$PATH"
      
      - name: Build with LLVM
        run: |
          export PATH="/opt/homebrew/opt/llvm@18/bin:$PATH"
          export LLVM_DIR="/opt/homebrew/opt/llvm@18/lib/cmake/llvm"
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DLLVM_DIR=$LLVM_DIR
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
        timeout-minutes: 10
      
      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp build/tulpar dist/tulpar-macos-universal
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tulpar-macos-universal
          path: dist/tulpar-macos-universal
  
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install LLVM
        run: |
          choco install llvm --version=18.1.8 -y
          choco install cmake -y
          choco install mingw -y
        shell: powershell
      
      - name: Set environment
        run: |
          $env:PATH = "C:\Program Files\LLVM\bin;$env:PATH"
          $env:LLVM_DIR = "C:\Program Files\LLVM\lib\cmake\llvm"
          echo "PATH=$env:PATH" >> $env:GITHUB_ENV
          echo "LLVM_DIR=$env:LLVM_DIR" >> $env:GITHUB_ENV
        shell: powershell
      
      - name: Build with LLVM
        run: |
          mkdir build
          cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
        timeout-minutes: 15
        shell: cmd
        continue-on-error: true
      
      - name: Prepare artifact
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          if (Test-Path build\tulpar.exe) {
            Copy-Item build\tulpar.exe dist\tulpar-windows-x64.exe
          } else {
            echo "Build failed, no executable produced"
          }
        shell: powershell
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tulpar-windows-x64
          path: dist/tulpar-windows-x64.exe
        if: success() || failure()
  
  create-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    continue-on-error: true
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tulpar-*
          merge-multiple: true
      
      - name: Compute release tag
        id: ver
        shell: bash
        run: |
          TAG="v2.1.0.${GITHUB_RUN_NUMBER}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: TulparLang ${{ steps.ver.outputs.tag }} (LLVM)
          body: |
            ## TulparLang ${{ steps.ver.outputs.tag }}
            
            **LLVM-Based AOT Compiler**
            
            ### Features
            - Native compilation via LLVM backend
            - For loops, try/catch, file I/O, modules
            - Cross-platform support
            
            ### Downloads
            - `tulpar-linux-x64` - Linux executable
            - `tulpar-macos-universal` - macOS executable
            - `tulpar-windows-x64.exe` - Windows executable
          draft: false
          prerelease: false
          files: |
            tulpar-windows-x64.exe
            tulpar-linux-x64
            tulpar-macos-universal
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
