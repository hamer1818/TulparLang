name: Cross-Platform Build (LLVM)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            /usr/lib/llvm-18
          key: apt-llvm18-${{ runner.os }}-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            apt-llvm18-${{ runner.os }}-
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake llvm-18-dev
      
      - name: Build with LLVM
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release -j$(nproc)
        timeout-minutes: 10
      
      - name: Run tests
        run: |
          cp build/tulpar tulpar
          chmod +x tulpar
          ./build.sh test
        timeout-minutes: 5
        continue-on-error: true
      
      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp build/tulpar dist/tulpar-linux-x64
          cp build/libtulpar_runtime.a dist/libtulpar_runtime-linux-x64.a
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tulpar-linux-x64
          path: dist/tulpar-linux-x64
  
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/opt/llvm@18
            /usr/local/opt/llvm@18
          key: homebrew-llvm18-${{ runner.os }}-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            homebrew-llvm18-${{ runner.os }}-
      
      - name: Install dependencies
        run: |
          brew install cmake llvm@18
          echo 'export PATH="/opt/homebrew/opt/llvm@18/bin:$PATH"' >> ~/.zshrc
          export PATH="/opt/homebrew/opt/llvm@18/bin:$PATH"
      
      - name: Build with LLVM
        run: |
          export PATH="/opt/homebrew/opt/llvm@18/bin:$PATH"
          export LLVM_DIR="/opt/homebrew/opt/llvm@18/lib/cmake/llvm"
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DLLVM_DIR=$LLVM_DIR
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
        timeout-minutes: 10
      
      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp build/tulpar dist/tulpar-macos-universal
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tulpar-macos-universal
          path: dist/tulpar-macos-universal
  
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          choco install llvm --version=18.1.8 -y
          choco install mingw -y
        shell: powershell
      
      - name: Find LLVM and set environment
        run: |
          # Find LLVM installation
          $llvmPaths = @(
            "C:\Program Files\LLVM",
            "C:\LLVM",
            "$env:ChocolateyInstall\lib\llvm\tools"
          )
          
          $llvmRoot = $null
          foreach ($path in $llvmPaths) {
            if (Test-Path "$path\bin\clang.exe") {
              $llvmRoot = $path
              break
            }
          }
          
          if (-not $llvmRoot) {
            Write-Host "❌ LLVM not found!"
            exit 1
          }
          
          Write-Host "✅ Found LLVM at: $llvmRoot"
          
          # Find cmake config
          $cmakeDirs = @(
            "$llvmRoot\lib\cmake\llvm",
            "$llvmRoot\share\llvm\cmake"
          )
          
          $llvmDir = $null
          foreach ($dir in $cmakeDirs) {
            if (Test-Path "$dir\LLVMConfig.cmake") {
              $llvmDir = $dir
              break
            }
          }
          
          if ($llvmDir) {
            Write-Host "✅ Found LLVM CMake config at: $llvmDir"
          } else {
            Write-Host "⚠️ CMake config not found, will use llvm-config"
          }
          
          # Set environment
          echo "$llvmRoot\bin" >> $env:GITHUB_PATH
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $env:GITHUB_PATH
          if ($llvmDir) {
            echo "LLVM_DIR=$llvmDir" >> $env:GITHUB_ENV
          }
          echo "LLVM_ROOT=$llvmRoot" >> $env:GITHUB_ENV
        shell: powershell
      
      - name: Build with LLVM
        run: |
          mkdir build
          cd build
          if defined LLVM_DIR (
            cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DLLVM_DIR="%LLVM_DIR%"
          ) else (
            cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          )
          cmake --build . --config Release
        timeout-minutes: 15
        shell: cmd
        continue-on-error: true
      
      - name: Verify build
        run: |
          if (Test-Path build\tulpar.exe) {
            Write-Host "✅ Build successful!"
            .\build\tulpar.exe --version 2>$null || Write-Host "Version check skipped"
          } else {
            Write-Host "⚠️ Build failed - tulpar.exe not found"
          }
        shell: powershell
      
      - name: Prepare artifact
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          if (Test-Path build\tulpar.exe) {
            Copy-Item build\tulpar.exe dist\tulpar-windows-x64.exe
            Write-Host "✅ Artifact prepared: dist\tulpar-windows-x64.exe"
          } else {
            Write-Host "⚠️ No executable to package - Windows build experimental"
          }
        shell: powershell
          if (Test-Path build\tulpar.exe) {
            Copy-Item build\tulpar.exe dist\tulpar-windows-x64.exe
            Write-Host "✅ Artifact prepared: dist\tulpar-windows-x64.exe"
          } else {
            Write-Host "❌ No executable to package"
            exit 1
          }
        shell: powershell
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tulpar-windows-x64
          path: dist/tulpar-windows-x64.exe
        if: success() || failure()
  
  create-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    continue-on-error: true
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tulpar-*
          merge-multiple: true
      
      - name: Compute release tag
        id: ver
        shell: bash
        run: |
          TAG="v2.1.0.${GITHUB_RUN_NUMBER}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: TulparLang ${{ steps.ver.outputs.tag }} (LLVM)
          body: |
            ## TulparLang ${{ steps.ver.outputs.tag }}
            
            **LLVM-Based AOT Compiler**
            
            ### Features
            - Native compilation via LLVM backend
            - For loops, try/catch, file I/O, modules
            - Cross-platform support
            
            ### Downloads
            - `tulpar-linux-x64` - Linux executable
            - `tulpar-macos-universal` - macOS executable
            - `tulpar-windows-x64.exe` - Windows executable
          draft: false
          prerelease: false
          files: |
            tulpar-windows-x64.exe
            tulpar-linux-x64
            tulpar-macos-universal
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
